"use strict";var Util={};!function(){Util.comma=d3.format(",.0f"),Util.percentize=d3.format("%"),Util.strToFloat=function(t){return"string"!=typeof t?t:parseFloat(t.replace(/[^\d\.\-]/g,""))},Util.capitalize=function(t){var e=t.split(" ");return e.map(function(t){return t.charAt(0).toUpperCase()+t.slice(1)}).join(" ")},Util.sortByKey=function(t,e,n){return t.sort(function(t,n){return t[e]<n[e]?-1:t[e]>n[e]?1:0}),n?t.reverse():t},Util.hasCommonElement=function(t,e){for(var n=e.length,a=0;a<n;a++)if(t.includes(e[a]))return!0;return!1},Util.getInputNumVal=function(t){var e=$(t),n=Util.strToFloat(e.val());return""===n?0:isNaN(n)||n<0?(e.val(0),0):(e.val(d3.format(",")(n)),n)},Util.populateSelect=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=d3.selectAll(t).selectAll("option").data(e);a.exit().remove();var o=a.enter().append("option");a=o.merge(a).attr("value",function(t){return"function"==typeof n.valKey?n.valKey(t):n.valKey?t[n.valKey]:t}).text(function(t){return"function"==typeof n.nameKey?n.nameKey(t):n.nameKey?t[n.nameKey]:t}),n.selected&&("boolean"==typeof n.selected?a.attr("selected",n.selected):"function"==typeof n.selected&&a.attr("selected",function(t){var e=n.valKey?t[n.valKey]:t;return n.selected(e)}))}}();var Routing={};!function(){function t(t,e){n(t);for(var a=arguments.length,o=Array(a>2?a-2:0),r=2;r<a;r++)o[r-2]=arguments[r];e&&e.apply(void 0,o),window.scrollTo(0,0)}function e(t){crossroads.parse(t)}function n(t,e){$("#page-content").html(a[t](e))}var a={};Routing.precompileTemplates=function(){$("script[type='text/x-handlebars-template']").each(function(t,e){a[e.id.replace("-template","")]=Handlebars.compile($(e).html())})},Routing.initializeRoutes=function(){crossroads.addRoute("/",function(){t("home",App.initHome)}),crossroads.addRoute("/analysis",function(){t("analysis",App.initAnalysis,"network")}),crossroads.addRoute("/analysis/country",function(){t("analysis",App.initAnalysis,"country")}),crossroads.addRoute("/analysis/{iso}",function(e){t("analysis-country",App.initAnalysisCountry,e)}),crossroads.addRoute("/analysis/{iso}/d",function(e){t("analysis-country",App.initAnalysisCountry,e,"d")}),crossroads.addRoute("/analysis/{iso}/r",function(e){t("analysis-country",App.initAnalysisCountry,e,"r")}),crossroads.addRoute("/analysis/{iso}/{type}/table",function(e,n){t("analysis-table",App.initAnalysisTable,e,n)}),crossroads.addRoute("/analysis/{fundIso}/{recIso}",function(e,n){t("analysis-pair",App.initAnalysisPair,e,n)}),crossroads.addRoute("/submit",function(){t("submit",App.initSubmit)}),crossroads.addRoute("/settings",function(){t("settings",App.initSettings)}),crossroads.addRoute("/about",function(){t("about")}),hasher.prependHash="",hasher.initialized.add(e),hasher.changed.add(e),hasher.init()}}();var App={};!function(){App.initialize=function(t){App.dataStartYear=2014,App.dataEndYear=2017,App.fundColor="#08519c",App.receiveColor="#a50f15",App.fundColorPalette=["#08519c","#3192bd","#6baed6","#bdd7e7","#eff3ff"],App.receiveColorPalette=["#a50f15","#de2d26","#fb6a4a","#fcae91","#fee5d9"],App.geoData=null,App.countries=[],App.fundingData=[],App.currencies={},App.currencyIso="USD",App.fundingLookup={},App.recipientLookup={},App.codeToNameMap=d3.map(),App.capacities=[{id:"P.1",name:"P.1 - National Legislation, Policy, and Financing"},{id:"P.2",name:"P.2 - IHR Coordination, Communicaton and Advocacy"},{id:"P.3",name:"P.3 - Antimicrobial Resistance (AMR)"},{id:"P.4",name:"P.4 - Zoonotic Disease"},{id:"P.5",name:"P.5 - Food Safety"},{id:"P.6",name:"P.6 - Biosafety and Biosecurity"},{id:"P.7",name:"P.7 - Immunization"},{id:"D.1",name:"D.1 - National Laboratory System"},{id:"D.2",name:"D.2 - Real Time Surveillance"},{id:"D.3",name:"D.3 - Reporting"},{id:"D.4",name:"D.4 - Workforce Development"},{id:"R.1",name:"R.1 - Preparedness"},{id:"R.2",name:"R.2 - Emergency Response Operations"},{id:"R.3",name:"R.3 - Linking Public Health and Security Authorities"},{id:"R.4",name:"R.4 - Medical Countermeasures and Personnel Deployment"},{id:"R.5",name:"R.5 - Risk Communication"},{id:"O.1",name:"O.1 - Point of Entry (PoE)"},{id:"General IHR Implementation",name:"General IHR Implementation"}],NProgress.start(),d3.queue().defer(d3.json,"data/world.json").defer(d3.csv,"data/unsd_data.csv").defer(d3.json,"data/donor_codes.json").defer(d3.json,"data/funding_data_v11.json").defer(d3.json,"data/currencies.json").await(function(e,n,a,o,r,i){if(e)throw e;App.geoData=n,App.countries=n.objects.countries.geometries.map(function(t){return t.properties});var c=d3.map();a.forEach(function(t){c.set(t["ISO-alpha3 Code"],t)}),App.countries.forEach(function(t){var e=c.get(t.ISO3);t.regionName=e["Region Name"],t.subRegionName=e["Sub-region Name"],t.intermediateRegionName=e["Intermediate Region Name"],App.codeToNameMap.set(t.ISO2,t.NAME)}),o.forEach(function(t){App.codeToNameMap.has(t.donor_code)||App.codeToNameMap.set(t.donor_code,t.donor_name)}),App.fundingData=r,App.currencies=Object.assign({},i),App.currencyIso="USD",App.fundingData.forEach(function(t,e){var n=t.donor_code,a=t.recipient_country;App.fundingLookup[n]||(App.fundingLookup[n]=[]),App.fundingLookup[n].push(t),App.recipientLookup[a]||(App.recipientLookup[a]=[]),App.recipientLookup[a].push(t)}),t&&t(),NProgress.done()}),$(".navbar-brand span").click(function(){return hasher.setHash("")})},App.siFormat=function(t){return t?d3.format(",.3s")(t).replace("G","B"):"0"},App.formatMoneyShort=function(t){var e=App.currencies[App.currencyIso].exchange_rates.find(function(t){return"USD"===t.convert_from}).multiplier,n=t*e;return n<100?Math.round(n):App.siFormat(n)},App.formatMoney=function(t){return App.formatMoneyShort(t)+" "+App.currencyIso},App.formatMoneyFull=function(t){return t<100?Math.round(t)+" "+App.currencyIso:d3.format(",.3r")(t)+" "+App.currencyIso},App.getTotalFunded=function(t){return App.fundingLookup[t]?d3.sum(App.fundingLookup[t],function(t){return t.total_spent}):0},App.getTotalFunded2=function(t){return App.fundingLookup[t]?d3.sum(App.fundingLookup[t],function(t){for(var e=0,n=App.dataStartYear;n<App.dataEndYear+1;n++)e+=t.spent_by_year[n];return e}):0},App.getTotalReceived=function(t){return App.recipientLookup[t]?d3.sum(App.recipientLookup[t],function(t){return t.total_spent}):0},App.getCountryName=function(t){return App.codeToNameMap.has(t)?App.codeToNameMap.get(t):t},App.getFlagHtml=function(t){return'<img class="flag" src="img/flags/'+t.toLowerCase()+'.png" />'},$.fn.DataTable.ext.pager.numbers_length=6,$.fn.dataTableExt.oSort["money-asc"]=function(t,e){var n=Util.strToFloat(t),a=Util.strToFloat(e);return n<a?-1:n>a?1:0},$.fn.dataTableExt.oSort["money-desc"]=function(t,e){var n=Util.strToFloat(t),a=Util.strToFloat(e);return n<a?1:n>a?-1:0},$.tooltipster.setDefaults({contentAsHTML:!0,trigger:"hover",offset:[5,-25],theme:"tooltipster-shadow",maxWidth:320}),$.noty.defaults.type="warning",$.noty.defaults.layout="center",$.noty.defaults.timeout=2e3}(),function(){App.initialize(function(){Routing.precompileTemplates(),Routing.initializeRoutes()})}(),function(){App.buildCategoryChart=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a="r"===n.moneyType?"Funder":"Recipient",o="r"===n.moneyType?App.receiveColorPalette:App.fundColorPalette;e.forEach(function(t){var e=0;t.children.forEach(function(t){t.value0=e,e+=t.total_spent,t.value1=e})});var r={top:70,right:80,bottom:80,left:40},i=440,c=450,l=d3.select(t).append("svg").classed("category-chart",!0).attr("width",i+r.left+r.right).attr("height",c+r.top+r.bottom).append("g").attr("transform","translate("+r.left+", "+r.top+")"),s=d3.max(e,function(t){return t.total_spent}),p=d3.scaleLinear().domain([0,1.1*s]).range([0,i]),d=d3.scaleBand().padding(.25).domain(e.map(function(t){return t.id})).range([0,c]),u=d3.scaleOrdinal().range(o),f=d3.axisTop().ticks(5).tickFormat(App.siFormat).scale(p),m=d3.axisLeft().scale(d),h=l.selectAll(".bar-group").data(e).enter().append("g").attr("class","bar-group").attr("transform",function(t){return"translate(0, "+d(t.id)+")"});h.selectAll("rect").data(function(t){return t.children.map(function(e){return{cc:t.id,country:e}})}).enter().append("rect").attr("x",function(t){return p(t.country.value0)}).attr("width",function(t){return p(t.country.value1)-p(t.country.value0)}).attr("height",d.bandwidth()).style("fill",function(t){return u(t.country.iso)}).each(function(t){$(this).tooltipster({content:"<b>Core Capacity:</b> "+t.cc+("<br><b>"+a+":</b> "+App.getCountryName(t.country.iso))+("<br><b>Total Committed Funds:</b> "+App.formatMoney(t.country.total_committed))+("<br><b>Total Disbursed Funds:</b> "+App.formatMoney(t.country.total_spent))})}),h.append("text").attr("class","bar-label").attr("x",function(t){return p(t.total_spent)+5}).attr("y",d.bandwidth()/2).attr("dy",".35em").text(function(t){return App.formatMoney(t.total_spent)}),l.append("g").attr("class","x axis").call(f),l.append("g").attr("class","y axis").call(m),l.selectAll(".y.axis .tick text").each(function(t){var e=App.capacities.find(function(e){return e.id===t}).name;$(this).tooltipster({content:"<b>"+e+"</b>"})});var v="Total Funds Disbursed by Core Capacity";"r"===n.moneyType&&(v="Total Funds Received by Core Capacity"),l.append("text").attr("class","axis-label").attr("x",i/2).attr("y",-35).text(v)}}(),function(){App.buildCirclePack=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=["#c6dbef","#084594"],o=n.colors||a,r={top:0,right:30,bottom:0,left:30},i=n.size||300,c=d3.select(t).append("svg").classed("circle-pack-chart",!0).attr("width",i+r.left+r.right).attr("height",i+r.top+r.bottom),l=c.append("g").attr("transform","translate("+r.left+", "+r.top+")"),s=c.append("defs"),p=s.append("filter").attr("id","glow");p.append("feGaussianBlur").attr("stdDeviation",3.5).attr("result","coloredBlur");var d=p.append("feMerge");d.append("feMergeNode").attr("in","coloredBlur"),d.append("feMergeNode").attr("in","SourceGraphic");var u=s.append("linearGradient").attr("id",t+"-gradient").attr("x1","0%").attr("x2","100%").attr("y1","0%").attr("y2","0%");u.append("stop").attr("stop-color",o[0]).attr("offset","0%"),u.append("stop").attr("stop-color",o[1]).attr("offset","100%");var f={name:"background",children:e.slice(0)},m=d3.pack().size([i,i]).padding(2),h=d3.hierarchy(f).sum(function(t){return t.total_spent}).sort(function(t,e){return e.total_spent-t.total_spent}),v=m(h).descendants(),y=d3.scaleLinear().range(o),g=l.selectAll("g").data(v).enter().append("g").attr("transform",function(t){return"translate("+t.x+", "+t.y+")"}).each(function(t){t.node=this}),A=g.append("g").attr("class",function(t){return t.parent?t.children?"node":"node node--leaf":"node node--root"}),b=A.append("circle").attr("r",function(t){return t.r}).filter(function(t){return t.parent}).style("fill",function(t){var e=t.data.total_spent/t.data.total_committed;return e>1&&(e=1),y(e)}).style("filter","url(#glow)").each(function(t){var e=d3.select(document.createElement("div")),n=e.append("div").attr("class","tooltip-content");n.append("div").attr("class","tooltip-title").text(t.data.NAME);var a=n.append("div").attr("class","tooltip-row-content");a.append("div").attr("class","tooltip-row").html("<b>Total Disbursed:</b> "+App.formatMoney(t.data.total_spent)),$(this).tooltipster({trigger:"hover",content:e.html()})});n.onClick&&b.on("click",function(t){return n.onClick(t.data.ISO2)})}}(),function(){App.populateCcDropdown=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={id:"",name:"None - No core capacity tagged"},a=App.capacities.concat(n);Util.populateSelect(t,a,{valKey:"id",nameKey:"name",selected:!0}),$(t).multiselect({maxHeight:260,includeSelectAllOption:!0,numberDisplayed:0,dropRight:e.dropRight||!1})},App.passesCategoryFilter=function(t,e){if(!t.length&&e.includes(""))return!0;for(var n=0;n<t.length;n++)if(e.includes(t[n]))return!0;return!1}}();var Map={};!function(){Map.createWorldMap=function(t,e){function n(){f.style("stroke-width",1.5/d3.event.transform.k+"px"),f.attr("transform",d3.event.transform)}function a(t){$(this.parentNode).append(this);var e=p.bounds(t),n=e[1][0]-e[0][0],a=e[1][1]-e[0][1],o=(e[0][0]+e[1][0])/2,r=(e[0][1]+e[1][1])/2,l=Math.max(1,Math.min(8,.7/Math.max(n/i,a/c))),s=[i/2-l*o,c/2-l*r-90];return u.transition().duration(750).call(d.transform,d3.zoomIdentity.translate(s[0],s[1]).scale(l))}function o(){u.transition().duration(750).call(d.transform,d3.zoomIdentity)}function r(){d3.event.defaultPrevented&&d3.event.stopPropagation()}var i=1200,c=640,l=170,s=d3.geoMercator().translate([i/2,c/2]).scale(l).precision(.1),p=d3.geoPath().projection(s),d=d3.zoom().scaleExtent([1,8]).on("zoom",n),u=d3.selectAll(t).append("svg").classed("map",!0).attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+i+" "+c).append("g").on("click",r,!0);u.append("rect").attr("class","overlay").attr("width",i).attr("height",c);var f=u.append("g"),m=f.append("g").attr("class","countries");f.append("g").attr("class","links");u.call(d);var h=topojson.feature(e,e.objects.countries).features;return m.selectAll(".country").data(h).enter().append("path").attr("class","country").attr("d",p),m.append("path").datum(topojson.mesh(e,e.objects.countries,function(t,e){return t!==e})).attr("class","boundary").attr("d",p),{element:u,projection:s,path:p,zoomTo:a,reset:o}}}(),function(){App.buildNetworkMap=function(t,e){function n(t){var e=F.selectAll(".arc").data(t);e.exit().remove(),e.enter().append("path").attr("class","region-arc arc").each(function(t){$(this).tooltipster({plugins:["follower"]})}).merge(e).each(function(t){var e='<div class="nm-tooltip-title">'+t.name+"</div>";t.totalFunded&&(e+="<div><b>Disbursed Funds:</b> "+App.formatMoney(t.totalFunded)+"</div>"),t.totalReceived&&(e+="<div><b>Received Funds:</b> "+App.formatMoney(t.totalReceived)+"</div>"),$(this).tooltipster("content",e)}).style("fill",r).attr("d",C);var n=R.selectAll(".arc").data(s);n.exit().remove(),n.enter().append("path").attr("class","subregion-arc arc").each(function(t){$(this).tooltipster({plugins:["follower"]})}).merge(n).each(function(t){var e='<div class="nm-tooltip-title">'+t.name+"</div>";t.totalFunded&&(e+="<div><b>Disbursed Funds:</b> "+App.formatMoney(t.totalFunded)+"</div>"),t.totalReceived&&(e+="<div><b>Received Funds:</b> "+App.formatMoney(t.totalReceived)+"</div>"),$(this).tooltipster("content",e)}).style("fill",r).attr("d",T);var a=w.selectAll(".arc").data(p);a.exit().remove(),a=a.enter().append("path").attr("class","country-arc arc").each(function(t){$(this).tooltipster({plugins:["follower"]})}).merge(a),a.on("mouseover",function(t){d3.selectAll(".link").filter(function(e){return e.donor===t.name||e.recipient===t.name}).classed("country-hover",!0)}).on("mouseout",function(t){d3.selectAll(".link").classed("country-hover",!1)}).each(function(t){var e='<div class="nm-tooltip-title">'+t.name+"</div>";t.totalFunded&&(e+="<div><b>Disbursed Funds:</b> "+App.formatMoney(t.totalFunded)+"</div>"),t.totalReceived&&(e+="<div><b>Received Funds:</b> "+App.formatMoney(t.totalReceived)+"</div>"),$(this).tooltipster("content",e)}).style("fill",r).style("stroke","#fff").attr("d",N),i.countryClickFn&&a.on("click",function(t){return i.countryClickFn(t.iso)});var o=F.selectAll(".arc-label-path").data(t);o.exit().remove(),o.enter().append("path").attr("class","arc-label-path").merge(o).attr("id",function(t,e){return"arc-path-"+e}).attr("d",S).style("fill","none").each(function(t){var e=/(^.+?)L/,n=e.exec(d3.select(this).attr("d"))[1];n=n.replace(/,/g," ");var a=(t.theta0+t.theta1)/2;if(a>Math.PI/2&&a<3*Math.PI/2){var o=/M(.*?)A/,r=/A(.*?)0 0 1/,i=/0 0 1 (.*?)$/,c=i.exec(n)[1],l=o.exec(n)[1],s=r.exec(n)[1];n="M"+c+"A"+s+"0 0 0 "+l}d3.select(this).attr("d",n)});var c=F.selectAll(".arc-label").data(t);c.exit().remove();var l=c.enter().append("text").attr("class","arc-label");l.append("textPath").attr("startOffset","50%"),c=l.merge(c).attr("dy",function(t){var e=(t.theta0+t.theta1)/2;return e>Math.PI/2&&e<3*Math.PI/2?18:-6}),c.select("textPath").attr("xlink:href",function(t,e){return"#arc-path-"+e}).text(function(t){return t.name})}function a(t){var e=x.selectAll(".link").data(d);e.exit().remove(),e.enter().append("path").attr("class","link").each(function(t){$(this).tooltipster({plugins:["follower"]})}).merge(e).attr("d",D).each(function(t){var e=App.codeToNameMap.get(t.donor),n=App.codeToNameMap.get(t.recipient),a="<b>Funder:</b> "+e+("<br><b>Recipient:</b> "+n)+("<br><b>Disbursed Funds:</b> "+App.formatMoney(t.value));$(this).tooltipster("content",a)}).transition().style("fill",M(0))}function o(t){s=[],p=[],d=[],u.empty();var e=d3.sum(t,function(t){return t.totalFlow}),n=0;t.forEach(function(t){var a=2*Math.PI*t.totalFlow/e-2*h;n+=h,t.theta0=n;var o=(t.children.length-1)*v;t.children.forEach(function(e,r){s.push(e);var i=(a-o)*(e.totalFlow/t.totalFlow);r>0&&(n+=v),e.theta0=n,e.children.forEach(function(t){u.set(t.iso,t),p.push(t),d=d.concat(t.funds);var a=i*(t.totalFlow/e.totalFlow);t.theta0=n,n+=a,t.theta1=n,t.runningTheta=t.theta0}),e.theta1=n}),t.theta1=n,n+=h}),t.forEach(function(t){t.children.forEach(function(t){t.children.forEach(function(t){t.funds.forEach(function(e){var n=(t.theta1-t.theta0)*(e.value/t.totalFlow);n<0&&(n=0),e.source={startAngle:t.runningTheta,endAngle:t.runningTheta+n},t.runningTheta+=n;var a=u.get(e.recipient),o=(a.theta1-a.theta0)*(e.value/a.totalFlow);o<0&&(o=0),e.target={startAngle:a.runningTheta,endAngle:a.runningTheta+o},a.runningTheta+=o})})})})}function r(t){var e=t.totalFunded,n=t.totalReceived;return M(n/(n+e))}var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},c=App.fundColor,l=App.receiveColor,s=[],p=[],d=[],u=d3.map(),f={top:60,right:60,bottom:120,left:60},m=i.radius||300,h=.02,v=.01,y=d3.select(t).append("svg").classed("network-map-chart",!0).attr("width",2*m+f.left+f.right).attr("height",2*m+f.top+f.bottom),g=y.append("g").attr("transform","translate("+(m+f.left)+", "+(m+f.top)+")"),A=y.append("defs"),b=A.append("linearGradient").attr("id","fund-gradient");b.append("stop").attr("stop-color",c).attr("offset","0%"),b.append("stop").attr("stop-color",l).attr("offset","100%");var _=A.append("clipPath").attr("id","circle-clip");_.append("circle").attr("r",m),g.append("rect").attr("class","overlay").attr("transform","translate("+(-m-f.left)+", "+(-m-f.top)+")").attr("width",2*m+f.left+f.right).attr("height",2*m+f.top+f.bottom);var x=g.append("g").attr("class","link-g").attr("clip-path","url(#circle-clip)"),k=g.append("g"),w=k.append("g"),R=k.append("g"),F=k.append("g"),M=d3.scaleLinear().range([c,l]),C=d3.arc().innerRadius(m+28).outerRadius(m+28+12).startAngle(function(t){return t.theta0}).endAngle(function(t){return t.theta1}),T=d3.arc().innerRadius(m+14).outerRadius(m+14+12).startAngle(function(t){return t.theta0}).endAngle(function(t){return t.theta1}),N=d3.arc().innerRadius(m).outerRadius(m+12).startAngle(function(t){return t.theta0}).endAngle(function(t){return t.theta1}),S=d3.arc().innerRadius(m+28).outerRadius(m+28+12).startAngle(function(t){return t.theta1-t.theta0>1?t.theta0:t.theta0-1}).endAngle(function(t){return t.theta1-t.theta0>1?t.theta1:t.theta1+1}),D=d3.ribbon().source(function(t){return t.source}).target(function(t){return t.target}).radius(m),P=450,E=14,I=g.append("g").attr("transform","translate("+-P/2+", "+(m+80)+")");return I.append("rect").attr("width",P).attr("height",E).style("fill","url(#fund-gradient)"),I.append("text").attr("class","legend-label").attr("y",E+12).attr("dy",".35em").style("text-anchor","start").text("Funds More"),I.append("text").attr("class","legend-label").attr("x",P).attr("y",E+12).attr("dy",".35em").style("text-anchor","end").text("Receives More"),g.update=function(t){o(t),n(t),a(t)},g.update(e),g}}(),function(){App.drawProgressCircles=function(t,e,n){function a(t){return function(e){var n=d3.interpolate(e.endAngle,t);return function(t){return e.endAngle=n(t),m(e)}}}var o=2*Math.PI,r=e.total_spent/e.total_committed;e.total_committed||(r=0);var i={top:0,right:10,bottom:0,left:10},c=55,l=35,s=d3.select(t).append("svg").classed("progress-circle-chart",!0).attr("width",2*c+i.left+i.right).attr("height",2*c+i.top+i.bottom),p=s.append("g").attr("transform","translate("+(c+i.left)+", "+(c+i.top)+")"),d=s.append("defs"),u=d.append("filter").attr("id","glow");u.append("feGaussianBlur").attr("stdDeviation",3.5).attr("result","coloredBlur");var f=u.append("feMerge");f.append("feMergeNode").attr("in","coloredBlur"),f.append("feMergeNode").attr("in","SourceGraphic");var m=d3.arc().innerRadius(l).outerRadius(c).startAngle(0),h=(p.append("path").datum({endAngle:o}).style("fill","#ccc").attr("d",m),p.append("path").datum({endAngle:0}).style("fill",n).attr("d",m));return p.append("text").attr("class","progress-circle-value").attr("dy",".35em").text(e.total_committed?d3.format(".0%")(r):"N/A"),h.transition().duration(1e3).attrTween("d",a(r*o)),p}}(),function(){App.initCountrySearchBar=function(t,e){function n(e,n){if(""===e.trim())return void u.hide();if(s=-1,a(),l=m.search(e),l.forEach(function(t){var e=t.item.POP2005?Math.log10(t.item.POP2005):0;t.score-=.02*e}),Util.sortByKey(l,"score"),u.show(),0===l.length)u.find(".live-search-no-results-text").show(),u.find(".live-search-results-contents").hide();else{u.find(".live-search-no-results-text").hide(),u.find(".live-search-results-contents").show();var o=d3.select(u[0]).select(".live-search-results-contents").selectAll(".live-search-results-box").data(l.slice(0,c));o.exit().remove();var r=o.enter().append("div").attr("class","live-search-results-box");r.append("div").attr("class","live-search-results-title"),r.append("div").attr("class","live-search-results-subtitle"),o=o.merge(r).on("mousedown",function(e){$(t).val(""),n(e.item)}),o.select(".live-search-results-title").text(function(t){return t.item.POP2005?t.item.NAME+" ("+t.item.ISO2+")":t.item.NAME}),o.select(".live-search-results-subtitle").style("display",function(t){return t.item.POP2005?"block":"none"}).html(function(t){return"Population: "+Util.comma(t.item.POP2005)})}}function a(){if(u.find(".live-search-results-box").removeClass("active"),s>-1){var t=s+1;u.find(".live-search-results-box:nth-child("+t+")").addClass("active")}}function o(){clearTimeout(i),u.hide()}var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=void 0,c=3,l=[],s=-1,p=$(t),d=p.find("input"),u=p.find(".live-search-results-container");r.topLayout?u.addClass("top-layout"):u.addClass("bottom-layout"),d.on("focus",function(){n($(this).val(),e)}).on("blur",o).on("keyup",function(r){clearTimeout(i);var p=$(this).val();13===r.which?s>=0?($(t).val(""),o(),e(l[s])):n(p,e):27===r.which?o():40===r.which?s<c-1&&(s++,a()):38===r.which?s>-1&&(s--,a()):i=setTimeout(function(){n(p,e)},250)});var f=App.countries.slice(0);r.includeNonCountries&&App.codeToNameMap.entries().forEach(function(t){App.countries.find(function(e){return e.ISO2===t.key})||f.push({ISO2:t.key,ISO3:t.key,NAME:t.value})});var m=new Fuse(f,{shouldSort:!0,threshold:.5,distance:100,includeScore:!0,keys:["ISO2","ISO3","NAME"]})}}(),function(){function t(t,e){var n=d3.selectAll(".slider").append("div").attr("class","slider-tick-box");n.selectAll(".slider-tick-vert").data(e).enter().append("div").attr("class","slider-tick-vert").style("left",function(t,n){return 100*n/(e.length-1)+"%"});var a=n.selectAll(".slider-tick-text-container").data(e).enter().append("div").attr("class","slider-tick-text-container").style("left",function(t,n){return 100*(2*n+1)/(2*(e.length-1))+"%"});a.append("div").attr("class","slider-tick-text").text(function(t,n){return n===e.length-1?"":t})}App.initSlider=function(e,n){var a=$(e).slider(n);return t(e,d3.range(n.min,n.max+1)),a}}(),function(){App.buildTimeChart=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a={top:30,right:150,bottom:35,left:60},o=500,r=90,i=d3.color(n.color||"steelblue"),c=n.lightColor||i.brighter(2),l=d3.select(t).append("svg").classed("time-chart",!0).attr("width",o+a.left+a.right).attr("height",r+a.top+a.bottom).append("g").attr("transform","translate("+a.left+", "+a.top+")"),s=d3.scaleBand().padding(.2).domain(e.map(function(t){return t.year})).range([0,o]),p=d3.max(e,function(t){return d3.max([t.total_spent,t.total_committed])}),d=d3.scaleLinear().domain([0,1.2*p]).range([r,0]),u=d3.axisBottom().scale(s),f=d3.axisLeft().ticks(4).tickFormat(App.siFormat).scale(d),m=s.bandwidth();l.append("g").attr("class","x axis").attr("transform","translate(0, "+r+")").call(u),l.append("g").attr("class","y axis").call(f);var h=l.selectAll(".bar-group").data(e).enter().append("g").attr("transform",function(t){return"translate("+s(t.year)+", 0)"});h.append("rect").attr("class","bar").attr("y",function(t){return d(t.total_spent)}).attr("width",m/2).attr("height",function(t){return r-d(t.total_spent)}).style("fill",c),h.append("text").attr("class","bar-text").attr("x",m/4).attr("y",function(t){return d(t.total_spent)-8}).attr("dy",".35em").text(function(t){return App.formatMoneyShort(t.total_spent)}),h.append("rect").attr("class","bar").attr("x",m/2).attr("y",function(t){return d(t.total_committed)}).attr("width",m/2).attr("height",function(t){return r-d(t.total_committed)}).style("fill",i),h.append("text").attr("class","bar-text").attr("x",3*m/4).attr("y",function(t){return d(t.total_committed)-8}).attr("dy",".35em").text(function(t){return App.formatMoneyShort(t.total_committed)}),l.append("text").attr("class","chart-label").attr("x",o/2).attr("y",r+35).text("Year"),l.append("text").attr("class","chart-label").attr("x",-48).attr("y",-12).style("text-anchor","start").text("Amount (in USD)");var v=12,y=l.append("g").attr("transform","translate("+(o+25)+", 5)"),g=y.selectAll("g").data([c,i]).enter().append("g").attr("transform",function(t,e){return"translate(0, "+44*e+")"});return g.append("rect").attr("width",v).attr("height",30).style("fill",function(t){return t}),g.append("text").attr("class","legend-label").attr("x",v+8).attr("y",11).text(function(t,e){return 0===e?"Committed":"Disbursed"}),g.append("text").attr("class","legend-label").attr("x",v+8).attr("y",27).text(function(t,e){return"d"===n.moneyType?"Funds":0===e?"Funds to Receive":"Funds Received"}),l}}(),function(){App.drawValueSquares=function(t,e,n){for(var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o={top:0,right:0,bottom:0,left:0},r=5,i=5,c=10,l=10,s=100,p=20,d=(c+r)*p-r,u=(l+i)*(s/p)-i,f=d3.select(t).append("svg").attr("width",d+o.left+o.right).attr("height",u+o.top+o.bottom).append("g").attr("transform","translate("+o.left+", "+o.top+")"),m=0;m<s;m++){var h=m+1<=Math.ceil(s*e),v=(c+r)*(m%p);a.right&&(v=d-v),f.append("rect").attr("x",v).attr("y",(l+i)*Math.floor(m/p)).attr("width",c).attr("height",l).style("fill",h?n:"#ccc")}return f}}(),function(){App.initAnalysis=function(t){function e(){n(),a(),"network"===t?(o(),r(),i(),f(),b=d()):"country"===t&&(c(),l(".donor-table",".recipient-table"))}function n(){$(".analysis-global-tab-container .btn").on("click",function(){y=$(this).attr("tab"),"network"===y?hasher.setHash("analysis"):hasher.setHash("analysis/"+y)})}function a(){$('.analysis-global-tab-container .btn[tab="'+y+'"]').addClass("active").siblings().removeClass("active"),$('.global-tab-content-container .tab-content[tab="'+y+'"]').slideDown().siblings().slideUp()}function o(){App.populateCcDropdown(".cc-select"),$(".cc-select").on("change",u),$(".network-map-options .radio-option").click(function(){var t=$(this);t.find("input").prop("checked",!0),t.siblings().find("input").prop("checked",!1),u()}),$(".committed-info-img").tooltipster({content:"The <b>amount committed</b> refers to the amount of money committed."}),$(".disbursed-info-img").tooltipster({content:"The <b>amount disbursed</b> refers to the amount of money the recipient country has received."})}function r(){var t=App.initSlider(".time-slider",{min:App.dataStartYear,max:App.dataEndYear+1,value:[g,A],tooltip:"hide"});return t.on("change",function(t){var e=t.target.value.split(",");+e[0]===g&&+e[1]===A||(g=+e[0],A=+e[1],u())}),t}function i(){App.initCountrySearchBar(".network-country-search",function(t){v(t.ISO2)},{includeNonCountries:!0})}function c(){App.initCountrySearchBar(".table-country-search",function(t){hasher.setHash("analysis/"+t.ISO2)},{topLayout:!0,includeNonCountries:!0})}function l(t,e){var n=10,a=App.fundColorPalette,o=App.receiveColorPalette,r=[];for(var i in App.fundingLookup)"Not reported"!==i&&r.push({iso:i,name:App.codeToNameMap.get(i),total_committed:d3.sum(App.fundingLookup[i],function(t){return t.total_committed}),total_spent:d3.sum(App.fundingLookup[i],function(t){return t.total_spent})});Util.sortByKey(r,"total_spent",!0);var c=[];for(var l in App.recipientLookup)"Not reported"!==l&&c.push({iso:l,name:App.codeToNameMap.get(l),total_committed:d3.sum(App.recipientLookup[l],function(t){return t.total_committed}),total_spent:d3.sum(App.recipientLookup[l],function(t){return t.total_spent})});Util.sortByKey(c,"total_spent",!0);var s=d3.select(t).select("tbody").selectAll("tr").data(r.slice(0,n)).enter().append("tr").style("background-color",function(t,e){return a[Math.floor(e/2)]}).style("color",function(t,e){return e<4?"#fff":"black"}).on("click",function(t){"Not reported"!==t.iso&&hasher.setHash("analysis/"+t.iso)});s.append("td").html(function(t){var e=App.countries.find(function(e){return e.ISO2===t.iso}),n=e?App.getFlagHtml(t.iso):"",a=App.codeToNameMap.get(t.iso);return'<div class="flag-container">'+n+"</div>"+('<div class="name-container">'+a+"</div>")}),s.append("td").text(function(t){return App.formatMoney(t.total_committed)}),s.append("td").text(function(t){return App.formatMoney(t.total_spent)});var p=d3.select(e).select("tbody").selectAll("tr").data(c.slice(0,n)).enter().append("tr").style("background-color",function(t,e){return o[Math.floor(e/2)]}).style("color",function(t,e){return e<4?"#fff":"black"}).on("click",function(t){"Not reported"!==t.iso&&hasher.setHash("analysis/"+t.iso)});p.append("td").html(function(t){var e=App.countries.find(function(e){return e.ISO2===t.iso}),n=e?App.getFlagHtml(t.iso):"",a=e?e.NAME:t.iso;return'<div class="flag-container">'+n+"</div>"+('<div class="name-container">'+a+"</div>")}),p.append("td").text(function(t){return App.formatMoney(t.total_committed)}),p.append("td").text(function(t){return App.formatMoney(t.total_spent)})}function s(){var t=$(".cc-select").val(),e=$(".money-type-filter input:checked").attr("ind"),n="committed"===e?"committed_by_year":"spent_by_year";return function(e){if("Not reported"===e.recipient_country)return 0;if(!App.passesCategoryFilter(e.core_capacities,t))return 0;for(var a=0,o=g;o<A;o++)a+=e[n][o];return a}}function p(){for(var t=s(),e=[],n={},a=function(e){var a=App.countries[e],o=a.ISO2,r=App.fundingLookup[o],i=App.recipientLookup[o],c=0,l=0;if(r&&(c=d3.sum(r,function(e){return t(e)})),i&&(l=d3.sum(i,function(e){return t(e)})),c||l){var s=a.regionName,p=a.subRegionName;n[s]||(n[s]={}),n[s][p]||(n[s][p]={}),n[s][p][o]||(n[s][p][o]={totalFunded:c,totalReceived:l,fundsByC:{}}),r&&r.forEach(function(e){var a=t(e);if(a){var r=e.recipient_country;n[s][p][o].fundsByC[r]||(n[s][p][o].fundsByC[r]=0),n[s][p][o].fundsByC[r]+=a}})}},o=0;o<App.countries.length;o++)a(o);n["Other Funders"]={Other:{}};var r=function(e){App.countries.find(function(t){return t.ISO2===e})||(n["Other Funders"].Other[e]={totalFunded:d3.sum(App.fundingLookup[e],function(e){return t(e)}),totalReceived:0,fundsByC:{}},App.fundingLookup[e].forEach(function(a){var o=t(a);if(o){var r=a.recipient_country;n["Other Funders"].Other[e].fundsByC[r]||(n["Other Funders"].Other[e].fundsByC[r]=0),n["Other Funders"].Other[e].fundsByC[r]+=o}}))};for(var i in App.fundingLookup)r(i);for(var c in n){var l={name:c,children:[],totalFunded:0,totalReceived:0,totalFlow:0};for(var p in n[c]){var d={name:p,children:[],totalFunded:0,totalReceived:0,totalFlow:0};for(var u in n[c][p]){var f=[];for(var m in n[c][p][u].fundsByC)f.push({
donor:u,recipient:m,value:n[c][p][u].fundsByC[m]});var h=n[c][p][u].totalFunded,v=n[c][p][u].totalReceived;d.children.push({name:App.codeToNameMap.get(u),iso:u,totalFunded:h,totalReceived:v,totalFlow:h+v,funds:f}),d.totalFunded+=h,d.totalReceived+=v,d.totalFlow+=h+v}l.children.push(d),l.totalFunded+=d.totalFunded,l.totalReceived+=d.totalReceived,l.totalFlow+=d.totalFlow}e.push(l)}return e}function d(){var t=p(),e=App.buildNetworkMap(".network-map-content",t,{countryClickFn:v});return e.select(".overlay").on("click",m),e}function u(){var t=p();t.length?($(".network-map-content").show(),$(".network-map-no-content").hide()):($(".network-map-content").hide(),$(".network-map-no-content").show()),b.update(t),$(".network-country-info").is(":visible")&&v(_)}function f(){$(".info-close-button").click(m)}function m(){h(),$(".network-country-info").slideUp()}function h(){d3.selectAll(".country-arc").classed("active",!1),d3.selectAll(".link").classed("search-hidden",!1)}function v(t){h();var e=App.codeToNameMap.get(t),n=d3.selectAll(".country-arc").filter(function(e){return e.iso===t}).classed("active",!0);if(d3.selectAll(".link").filter(function(e){return e.donor!==t&&e.recipient!==t}).classed("search-hidden",!0),n.empty())return noty({text:"<b>There are no funding data for "+e+" in this time range."}),void h();var a=n.datum();_=t,$(".nci-title").text(e),a.totalFunded?($(".nci-donor-value").text(App.formatMoney(a.totalFunded)),$(".nci-donor-section").slideDown()):$(".nci-donor-section").slideUp(),a.totalReceived?($(".nci-recipient-value").text(App.formatMoney(a.totalReceived)),$(".nci-recipient-section").slideDown()):$(".nci-recipient-section").slideUp(),$(".nci-more-button").off("click").on("click",function(){hasher.setHash("analysis/"+a.iso)}),$(".network-country-info").slideDown()}var y=t,g=App.dataStartYear,A=App.dataEndYear+1,b=void 0,_=void 0;e()}}(),function(){App.initAnalysisCountry=function(t,e){function n(){var n=s?App.getFlagHtml(t):"";$(".analysis-country-title").html(n+" "+p+" "+n).on("click",function(){return hasher.setHash("analysis/"+t)}),$(".start-year").text(App.dataStartYear),$(".end-year").text(App.dataEndYear),$(".money-type").text("d"===e?"disbursed":"received"),$(".money-type-cap").text("d"===e?"Disbursed":"Received"),$(".money-type-noun").text("d"===e?"funder":"recipient"),$(".money-type-noun-cap").text("d"===e?"Funder":"Recipient"),$(".opp-money-type-noun").text("d"===e?"recipient":"funder"),$(".opp-money-type-verb").text("d"===e?"received":"donated"),e?o():a()}function a(){var e=App.getTotalFunded(t),n=App.getTotalReceived(t);if(e>n)return void hasher.setHash("analysis/"+t+"/d");if(n>e)return void hasher.setHash("analysis/"+t+"/r");$(".country-region").text(s.regionName),$(".country-subregion").text(s.subRegionName),s.intermediateRegionName?$(".country-intermediate").text(s.intermediateRegionName):$(".country-intermediate").closest(".country-details-row").hide(),$(".country-population").text(d3.format(",")(s.POP2005)),$(".country-funded-value").text(App.formatMoney(e)),$(".country-received-value").text(App.formatMoney(n)),$(".show-donor-btn").click(function(){return hasher.setHash("analysis/"+t+"/d")}),$(".show-recipient-btn").click(function(){return hasher.setHash("analysis/"+t+"/r")});var a=0,o=0;for(var r in App.fundingLookup)if("Not reported"!==r){var i=d3.sum(App.fundingLookup[r],function(t){return t.total_spent});i>a&&(a=i)}for(var c in App.recipientLookup)if("Not reported"!==c){var l=d3.sum(App.recipientLookup[c],function(t){return t.total_spent});l>o&&(o=l)}var p=e/a,d=n/o;App.drawValueSquares(".donor-squares",p,App.fundColor,{right:!0}),App.drawValueSquares(".recipient-squares",d,App.receiveColor),$(".country-summary-content").slideDown()}function o(){if($(".show-table-btn").click(function(){hasher.setHash("analysis/"+t+"/"+e+"/table")}),"d"===e){var n=App.getTotalReceived(t);n?$(".switch-type-button").text("Switch to Recipient Profile").on("click",function(){return hasher.setHash("analysis/"+t+"/r")}):$(".switch-type-button").hide();var a=App.getTotalFunded(t);$(".country-summary-value").text(App.formatMoney(a))}else if("r"===e){var o=App.getTotalFunded(t);o?$(".switch-type-button").text("Switch to Funder Profile").on("click",function(){return hasher.setHash("analysis/"+t+"/d")}):$(".switch-type-button").hide();var s=App.getTotalReceived(t);$(".country-summary-value").text(App.formatMoney(s))}r(),i(),c(),$(".country-flow-content").slideDown(),l()}function r(){if(d[t]){for(var n=[],a={},o=App.dataStartYear;o<=App.dataEndYear;o++)a[o]={year:o,total_committed:0,total_spent:0};d[t].forEach(function(t){for(var e=App.dataStartYear;e<=App.dataEndYear;e++)a[e].total_committed+=t.committed_by_year[e],a[e].total_spent+=t.spent_by_year[e]});for(var r in a)n.push(a[r]);App.buildTimeChart(".time-chart-container",n,{color:u,lightColor:f,moneyType:e})}}function i(){$(".progress-circle-title .info-img").tooltipster({content:"The <b>percent of committed funds</b> that were disbursed is shown. However, note that not all projects with disbursals have corresponding commitments, so these figures do not take into account all known funding initiatives."});var e=["P","D","R"];if(d[t]){var n=function(t,e){if(a[e].total_committed){var n=a[e].total_spent/a[e].total_committed;$(t).text(o(n))}else $(t).parent().text("No funds committed for this core element")},a={};e.forEach(function(t){a[t]={cc:t,total_committed:0,total_spent:0}}),d[t].forEach(function(t){e.forEach(function(e){if(t.core_capacities.some(function(t){return e===t.charAt(0)})){var n=t.total_committed,o=t.total_spent;o>n&&(o=n),a[e].total_committed+=n,a[e].total_spent+=o}})}),App.drawProgressCircles(".prevent-circle-chart",a.P,u),App.drawProgressCircles(".detect-circle-chart",a.D,u),App.drawProgressCircles(".respond-circle-chart",a.R,u);var o=d3.format(".0%");n(".prevent-value","P"),n(".detect-value","D"),n(".respond-value","R")}}function c(){"d"===e?$(".circle-pack-title").text("Top Recipients of Funds (from Funder)"):$(".circle-pack-title").text("Top Funders Received From");if(d[t]){var n="d"===e?"recipient_country":"donor_code",a=[],o={};d[t].forEach(function(t){var e=t[n];"Not reported"!==e&&(o[e]||(o[e]={iso:e,total_committed:0,total_spent:0}),o[e].total_committed+=t.total_committed,o[e].total_spent+=t.total_spent)});for(var r in o)a.push(o[r]);Util.sortByKey(a,"total_spent",!0);var i="d"===e?"Recipient":"Funder";$(".country-table thead tr td:first-child").text(i);var c=d3.select(".country-table tbody").selectAll("tr").data(a.slice(0,10)).enter().append("tr").on("click",function(n){console.log("tr click"),"Not reported"!==n.iso&&("d"===e?hasher.setHash("analysis/"+t+"/"+n.iso):hasher.setHash("analysis/"+n.iso+"/"+t))});c.append("td").html(function(t){var e=App.countries.find(function(e){return e.ISO2===t.iso}),n=e?App.getFlagHtml(t.iso):"",a=App.codeToNameMap.get(t.iso),o="event.stopPropagation();hasher.setHash('analysis/"+t.iso+"')";return'<div class="flag-container">'+n+'</div><div class="name-container">'+('<span onclick="'+o+'">'+a+"</span>")+"</div>"}),c.append("td").text(function(t){return App.formatMoney(t.total_committed)}),c.append("td").text(function(t){return App.formatMoney(t.total_spent)})}else d3.select(".circle-pack-description").html("<i>There are no data for recipients funded by this funder.</i>")}function l(){var n="d"===e?"recipient_country":"donor_code";if(d[t]){var a=[],o={};d[t].forEach(function(t){var e=t[n],a=t.core_capacities;a.forEach(function(n){o[n]||(o[n]={}),o[n][e]||(o[n][e]={iso:e,total_committed:0,total_spent:0}),o[n][e].total_committed+=t.total_committed,o[n][e].total_spent+=t.total_spent})}),App.capacities.forEach(function(t){if("General IHR Implementation"!==t.id)if(o[t.id]){var e=[],n=0,r=0;for(var i in o[t.id])e.push(o[t.id][i]),n+=o[t.id][i].total_committed,r+=o[t.id][i].total_spent;a.push({id:t.id,name:t.name,children:e,total_committed:n,total_spent:r})}else a.push({id:t.id,name:t.name,children:[],total_committed:0,total_spent:0})}),Util.sortByKey(a,"total_spent",!0),App.buildCategoryChart(".category-chart-container",a,{moneyType:e})}}var s=App.countries.find(function(e){return e.ISO2===t}),p=App.codeToNameMap.get(t),d="d"===e?App.fundingLookup:App.recipientLookup,u="d"===e?App.fundColor:App.receiveColor,f="d"===e?App.fundColorPalette[2]:App.receiveColorPalette[2];n()}}(),function(){var t=void 0,e=!1,n="all";App.initAnalysisPair=function(a,o){function r(){var t=p?App.getFlagHtml(a):"",e=d?App.getFlagHtml(o):"",r="<span onclick=\"hasher.setHash('analysis/"+a+"')\">"+u+"</span>",l="<span onclick=\"hasher.setHash('analysis/"+o+"')\">"+f+"</span>";s.find(".analysis-country-title").html(t+" "+r+" "+('<div class="arrow-html">&rarr;</div> '+l+" "+e)),$(".start-year").text(App.dataStartYear),$(".end-year").text(App.dataEndYear);var h=d3.sum(m,function(t){return t.total_committed}),v=d3.sum(m,function(t){return t.total_spent});$(".committed-value").text(App.formatMoney(h)),$(".spent-value").text(App.formatMoney(v)),$(".donor-button").click(function(){return hasher.setHash("analysis/"+a+"/d")}),$(".recipient-button").click(function(){return hasher.setHash("analysis/"+o+"/r")}),s.find(".funds-tab-container .btn").on("click",function(){n=$(this).attr("tab"),i(),c()}),i(),c()}function i(){s.find('.funds-tab-container .btn[tab="'+n+'"]').addClass("active").siblings().removeClass("active")}function c(){var a=[];"all"===n?a=[{name:"Funder",value:"donor_name"},{name:"Recipient",value:"recipient_name"},{name:"Name",value:"project_name"},{name:"Committed",value:"total_committed",type:"money"},{name:"Disbursed",value:"total_spent",type:"money"}]:"cc"===n&&(a=[{name:"Core Capacity",value:function(t){console.log(t);var e=App.capacities.find(function(e){return e.id===t.cc});return e?e.name:""}},{name:"Committed",value:"total_committed",type:"money"},{name:"Disbursed",value:"total_spent",type:"money"}]);var o=[];if("all"===n)o=m.slice(0);else if("cc"===n){var r={};m.forEach(function(t){t.core_capacities.forEach(function(e){r[e]||(r[e]={total_committed:0,total_spent:0}),r[e].total_committed+=t.total_committed,r[e].total_spent+=t.total_spent})});for(var i in r)o.push({cc:i,total_committed:r[i].total_committed,total_spent:r[i].total_spent})}e&&t.destroy();var c=l.select(".funds-table"),p=c.select("thead tr"),d=p.selectAll("th").data(a);d.exit().remove(),d.enter().append("th").merge(d).classed("money-cell",function(t){return"money"===t.type}).text(function(t){return t.name});var u=c.select("tbody"),f=u.selectAll("tr").data(o);f.exit().remove();var h=f.enter().append("tr"),v=h.merge(f).selectAll("td").data(function(t){return a.map(function(e){return{rowData:t,colData:e}})});v.exit().remove(),v.enter().append("td").merge(v).classed("money-cell",function(t){return"money"===t.colData.type}).text(function(t){var e="";return e="function"==typeof t.colData.value?t.colData.value(t.rowData):t.rowData[t.colData.value],"money"===t.colData.type?App.formatMoneyFull(e):e});var y=[],g=[];"all"===n?(y=[4,"desc"],g=[{type:"money",targets:[3,4],width:"120px"}]):"cc"===n&&(y=[2,"desc"],g=[{type:"money",targets:[1,2],width:"120px"}]),t=s.find(".funds-table").DataTable({scrollY:"30vh",scrollCollapse:!0,order:y,columnDefs:g}),e=!0}var l=d3.select(".analysis-pair-content"),s=$(".analysis-pair-content"),p=App.countries.find(function(t){return t.ISO2===a}),d=App.countries.find(function(t){return t.ISO2===o}),u=App.codeToNameMap.get(a),f=App.codeToNameMap.get(o),m=[];App.fundingLookup[a]&&(m=App.fundingLookup[a].filter(function(t){return t.recipient_country===o})),r()}}(),function(){var t=void 0,e=!1,n="all";App.initAnalysisTable=function(a,o){function r(){var t=s?App.getFlagHtml(a):"";$(".analysis-country-title").html(t+" "+p+" "+t).on("click",function(){return hasher.setHash("analysis/"+a)}),$(".money-type-noun").text("d"===o?"Funder":"Recipient"),$(".opp-money-type-noun").text("d"===o?"Recipient":"Funder"),$(".money-type-cap").text("d"===o?"Disbursed":"Received"),$(".commit-noun").text("d"===o?"Committed Funds":"Committed Funds to Receive"),$(".start-year").text(App.dataStartYear),$(".end-year").text(App.dataEndYear);var e=d3.sum(d,function(t){return t.total_committed}),n=d3.sum(d,function(t){return t.total_spent});$(".committed-value").text(App.formatMoney(e)),$(".spent-value").text(App.formatMoney(n)),$(".back-button").click(function(){return hasher.setHash("analysis/"+a+"/"+o)}),i(),c(),l()}function i(){$(".funds-tab-container .btn").on("click",function(){n=$(this).attr("tab"),c(),l()})}function c(){$('.funds-tab-container .btn[tab="'+n+'"]').addClass("active").siblings().removeClass("active")}function l(){var a=[];"all"===n?a=[{name:"Funder",value:"donor_name"},{name:"Recipient",value:"recipient_name"},{name:"Project Name",value:"project_name"},{name:"Committed",value:"total_committed",type:"money"},{name:"Disbursed",value:"total_spent",type:"money"}]:"country"===n?a=[{name:"Funder",value:function(t){return App.codeToNameMap.get(t.donor_code)}},{name:"Recipient",value:function(t){return App.codeToNameMap.get(t.recipient_country)}},{name:"Committed",value:"total_committed",type:"money"},{name:"Disbursed",value:"total_spent",type:"money"}]:"ce"===n?a=[{name:"Core Element",value:function(t){return"P"===t.ce?"Prevent":"D"===t.ce?"Detect":"R"===t.ce?"Respond":"O"===t.ce?"Other":"None"}},{name:"Committed",value:"total_committed",type:"money"},{name:"Disbursed",value:"total_spent",type:"money"}]:"cc"===n&&(a=[{name:"Core Capacity",value:function(t){var e=App.capacities.find(function(e){return e.id===t.cc});return e?e.name:t.cc}},{name:"Committed",value:"total_committed",type:"money"},{name:"Disbursed",value:"total_spent",type:"money"}]);var o=[];if("all"===n)o=d.slice(0);else if("country"===n){var r={};d.forEach(function(t){var e=t.donor_code,n=t.recipient_country;r[e]||(r[e]={}),r[e][n]||(r[e][n]={total_committed:0,total_spent:0}),r[e][n].total_committed+=t.total_committed,r[e][n].total_spent+=t.total_spent});for(var i in r)for(var c in r[i])o.push({donor_code:i,recipient_country:c,total_committed:r[i][c].total_committed,total_spent:r[i][c].total_spent})}else if("ce"===n){var l={},s=["P","D","R","O"];s.concat("None").forEach(function(t){l[t]={total_committed:0,total_spent:0}}),d.forEach(function(t){var e=!1;s.forEach(function(n){t.core_capacities.some(function(t){return t.slice(0,2)===n+"."})&&(e=!0,l[n].total_committed+=t.total_committed,l[n].total_spent+=t.total_spent)}),e||(l.None.total_committed+=t.total_committed,l.None.total_spent+=t.total_spent)});for(var p in l)o.push({ce:p,total_committed:l[p].total_committed,total_spent:l[p].total_spent})}else if("cc"===n){var u={};App.capacities.concat({id:"None"}).forEach(function(t){u[t.id]={total_committed:0,total_spent:0}}),d.forEach(function(t){t.core_capacities.forEach(function(e){u[e]&&(u[e].total_committed+=t.total_committed,u[e].total_spent+=t.total_spent)}),t.core_capacities.length||(u.None.total_committed+=t.total_committed,u.None.total_spent+=t.total_spent)});for(var f in u)o.push({cc:f,total_committed:u[f].total_committed,total_spent:u[f].total_spent})}e&&t.destroy();var m=d3.select(".funds-table"),h=m.select("thead tr"),v=h.selectAll("th").data(a);v.exit().remove(),v.enter().append("th").merge(v).classed("money-cell",function(t){return"money"===t.type}).text(function(t){return t.name});var y=m.select("tbody"),g=y.selectAll("tr").data(o);g.exit().remove();var A=g.enter().append("tr");A.merge(g).on("click",function(t){hasher.setHash("analysis/"+t.donor_code+"/"+t.recipient_country)});var b=A.merge(g).selectAll("td").data(function(t){return a.map(function(e){return{rowData:t,colData:e}})});b.exit().remove(),b.enter().append("td").merge(b).classed("money-cell",function(t){return"money"===t.colData.type}).text(function(t){var e="";return e="function"==typeof t.colData.value?t.colData.value(t.rowData):t.rowData[t.colData.value],"money"===t.colData.type?App.formatMoneyFull(e):e});var _=[4,"desc"],x=[];"all"===n?x=[{targets:[0,1],width:"140px"},{type:"money",targets:[3,4],width:"110px"}]:"country"===n?(_=[3,"desc"],x=[{targets:[0,1],width:"150px"},{type:"money",targets:[2,3],width:"120px"}]):"ce"!==n&&"cc"!==n||(_=[2,"desc"],x=[{type:"money",targets:[1,2],width:"120px"}]),t=$(".funds-table").DataTable({scrollY:"40vh",scrollCollapse:!0,order:_,columnDefs:x}),e=!0}var s=App.countries.find(function(t){return t.ISO2===a}),p=App.codeToNameMap.get(a),d=[];"d"===o&&App.fundingLookup[a]&&(d=App.fundingLookup[a].slice(0)),"r"===o&&App.recipientLookup[a]&&(d=App.recipientLookup[a].slice(0)),r()}}(),function(){App.initHome=function(){function t(){g=e(),f(),y(),l()}function e(){var t=Map.createWorldMap(".map-container",App.geoData);return t.element.select(".overlay").on("click",n),d3.selectAll(".country").on("click",function(e){return A.node()===this?n():(A.classed("active",!1),A=d3.select(this).classed("active",!0),t.zoomTo.call(this,e),void u())}).each(function(t){$(this).tooltipster({plugins:["follower"],delay:100,minWidth:200,content:t.properties.NAME})}),$(".legend-display-tab").click(function(){var t=$(this).find(".collapse-arrow").toggleClass("rotated");$(this).find("span").text(t.hasClass("rotated")?"show legend":"hide legend"),$(".legend-content").slideToggle()}),t}function n(){g.reset(),A.classed("active",!1),A=d3.select(null),$(".info-container").slideUp()}function a(){return $(".money-flow-type-filter input:checked").attr("ind")}function o(){return $(".money-type-filter input:checked").attr("ind")}function r(){var t=o();return"committed"===t?"total_committed":"total_spent"}function i(t,e){var n="";return"funded"===t&&"committed"===e?n="Committed Funds":"funded"===t&&"disbursed"===e?n="Disbursed Funds":"received"===t&&"committed"===e?n="Committed<br>Funds to Receive":"received"===t&&"disbursed"===e&&(n="Received Funds"),"Total "+n+("<br>from <b>"+_+"</b> to <b>"+(x-1)+"</b>")}function c(){return"received"===a()?App.recipientLookup:App.fundingLookup}function l(){s(),p(),$(".info-container").is(":visible")&&u()}function s(){var t=(a(),c()),e=$(".cc-select").val();b.clear(),App.countries.forEach(function(n){var a=t[n.ISO2];if(a){for(var o=0,r=0,i=0,c=a.length;i<c;i++){var l=a[i];if(App.passesCategoryFilter(l.core_capacities,e))for(var s=_;s<x;s++)o+=l.committed_by_year[s]||0,r+=l.spent_by_year[s]||0}b.set(n.ISO2,{total_committed:o,total_spent:r})}})}function p(){var t=a(),e=o(),n=r();d3.selectAll(".country-arc, .link").classed("active",!1);var c=b.values().map(function(t){return t[n]}).filter(function(t){return t});1===c.length&&c.push(0);var l=d3.scaleQuantile().domain(c).range(k);g.element.selectAll(".country").transition().duration(500).style("fill",function(t){var e=t.properties.ISO2;return b.has(e)?(t.value=b.get(e)[n],t.color=t.value?l(t.value):"#ccc"):(t.value=null,t.color="#ccc"),t.color}).each(function(n){var a=d3.select(document.createElement("div"));a.append("div").attr("class","tooltip-title").text(n.properties.NAME),a.append("div").attr("class","tooltip-profile-type").text("funded"===t?"Funder Information":"Recipient Information"),a.append("div").attr("class","tooltip-main-value").text(App.formatMoney(n.value)),a.append("div").attr("class","tooltip-main-value-label").html(i(t,e)),$(this).tooltipster("content",a.html())}),d(l)}function d(t){var e=r(),n=16,o=70,i=20,c=t.range(),l=t.quantiles(),s=d3.max(b.values().map(function(t){return t[e]})),p=d3.select(".legend").attr("width",o*c.length+2*i).attr("height",n+48).select("g").attr("transform","translate("+i+", 0)"),d=p.selectAll("g").data(c);d.exit().remove();var u=d.enter().append("g");u.append("rect").attr("class","legend-bar"),u.append("text").attr("class","legend-text"),d=d.merge(u).attr("transform",function(t,e){return"translate("+o*e+", 0)"}),d.select(".legend-bar").attr("width",o).attr("height",n).style("fill",function(t){return t}),d.select(".legend-text").attr("x",o).attr("y",n+12).attr("dy",".35em").text(function(t,e){return e===l.length?App.formatMoneyShort(s):App.formatMoneyShort(l[e])}),p.selectAll(".legend-start-label").data([!0]).enter().append("text").attr("class","legend-start-label").attr("y",n+12).attr("dy",".35em").text(0);var f="funded"===a()?"Funds Donated":"Funds Received";f+=" (in "+App.currencyIso+")";var m=p.selectAll(".legend-title").data([f]),h=m.enter().append("text").attr("class","legend-title");m.merge(h).attr("x",o*c.length/2).attr("y",n+45).text(function(t){return t}),$(".legend-container").slideDown()}function u(){var t=A.datum().properties,e=a();o();$(".info-title").text(t.NAME),$(".info-profile-type").text("funded"===e?"Funder Information":"Recipient Information"),$(".info-analysis-button").off("click").on("click",function(){hasher.setHash("analysis/"+t.ISO2)});var n=0,r=0;if(b.has(t.ISO2)){var c=b.get(t.ISO2);n+=c.total_committed,r+=c.total_spent}$(".info-committed-value").text(App.formatMoney(n)),$(".info-spent-value").text(App.formatMoney(r)),$(".info-committed-value-label").html(i(e,"committed")),$(".info-spent-value-label").html(i(e,"disbursed")),$(".info-container").slideDown()}function f(){$(".map-options-title").click(function(){$(this).find(".collapse-arrow").toggleClass("rotated"),$(".map-options-content").slideToggle()}),v(),h(),m()}function m(){App.initCountrySearchBar(".search-container",function(t){var e=d3.selectAll(".country").filter(function(e){return t.ISO2===e.properties.ISO2});A.classed("active",!1),A=e.classed("active",!0),g.zoomTo.call(A.node(),A.datum()),u()})}function h(){var t=App.initSlider(".time-slider",{min:App.dataStartYear,max:App.dataEndYear+1,value:[_,x],tooltip:"hide"});return t.on("change",function(t){var e=t.target.value.split(",");+e[0]===_&&+e[1]===x||(_=+e[0],x=+e[1],l())}),t}function v(){App.populateCcDropdown(".cc-select",{dropRight:!0}),$(".map-options-container .radio-option").click(function(){var t=$(this);t.find("input").prop("checked",!0),t.siblings().find("input").prop("checked",!1)}),$(".money-flow-type-filter .radio-option").click(function(){var t=a();$('.info-tab-container .btn[tab="country"]').text("received"===t?"By Donor":"By Recipient"),l()}),$(".money-type-filter .radio-option").click(l),$(".links-filter .radio-option").click(function(){$(".country-link").toggle()}),$(".map-options-container select").on("change",l),$(".committed-info-img").tooltipster({content:"The <b>amount committed</b> refers to the amount of money committed."}),$(".disbursed-info-img").tooltipster({content:"The <b>amount disbursed</b> refers to the amount of money the recipient country has received."}),$(".map-options-container").show()}function y(){$(".info-close-button").on("click",n)}var g=void 0,A=d3.select(null),b=d3.map(),_=App.dataStartYear,x=App.dataEndYear+1,k=["#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#8c6bb1","#88419d","#810f7c","#4d004b"];t()}}(),function(){App.initSettings=function(){var t=Object.values(App.currencies).sort(function(t,e){return d3.ascending(t.name,e.name)});Util.populateSelect(".currency-select",t,{nameKey:function(t){return Util.capitalize(t.name)+" ("+t.iso.code+")"},valKey:function(t){return t.iso.code}}),$(".currency-select").val(App.currencyIso).on("change",function(){App.currencyIso=$(this).val()})}}(),function(){App.initSubmit=function(){$(".start-date-input, .end-date-input").datepicker({autoclose:!0,assumeNearbyYear:!0,clearBtn:!0,container:".submit-page-container",immediateUpdates:!0}),Util.populateSelect(".country-select",App.countries,{valKey:"ISO2",nameKey:"NAME"}),Util.populateSelect(".cc-select",App.capacities,{valKey:"id",nameKey:"name"}),$(".cc-select").multiselect({maxHeight:260,numberDisplayed:1}),$(".btn-report-upload").on("click",function(){$(".input-report-upload").trigger("click")}),$(".input-report-upload").on("change",function(){if("files"in this){if(!this.files.length)return;var t=this.files[0],e=t.name.split("."),n=e[e.length-1];if("xlsx"!==n&&"xls"!==n)return void noty({timeout:5e3,text:"<b>Please select a file with a file type extension of <i>.xls</i> or <i>.xlsx</i>"});var a=new FileReader;a.onload=function(t){NProgress.start();var e=App.submitProjectReport(t.target.result);e?noty({timeout:4e3,type:"success",text:"<b>Upload Successful!</b><br>Project report has been submitted."}):noty({timeout:5e3,text:"<b>Error!</b><br>There was an error uploading the project report. Please check the file format."}),NProgress.done()},a.readAsBinaryString(t)}})},App.submitProjectReport=function(t){return console.log(t),!0}}();