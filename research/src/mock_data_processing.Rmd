---
title: "GHSA Data Processing"
author: "Steph Eaneff"
date: "8/7/2017"
output:
  html_document:
    toc: true
    toc_depth: 2
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
## do you want to save csvs when you run this Rmd file?
csv_flag <- TRUE
```


```{r, warning = FALSE, message = FALSE}
library(dplyr) ## restructure/aggregate data
library(reshape2) ## reshape data
library(DT) ## print pretty datatables
```

# Data

## CRS

CRS data are not currently being used because data exporter tool does not function as expected, and returns partial data plus an error message (only reports net disbursements, but not commitments, and returns an error at the bottom of a large, but partial csv file)

**Source:** OECD CRS (Organization for Economic Cooperation and Development Creditor Reporting System)  
**Dataset:** custom export using CRS Query Wizard  
**Dataset details:** Recipient (Developing Countries, Total); Sector (13 Sectors from Health and Agriculture, additional detail providerd in subdirectory readme); Channel (All Channels); Flow Type (Commitments and Dispersements); Type of Aid (All Types, Total); Amount Type (Constant Prices); Unit (US Dollar, Millions, 2015)  
**Brief description:** Health and agricultural funding provided to developing countries from 102 unique donors including countries and organizations from 2010-2015  
**Level of aggregation:** Funder, Flow Type (Disbursements vs. Commitments) country, geographic region, health focus area  
**General Location:** https://stats.oecd.org/Index.aspx?DataSetCode=CRS1  
**Specific Location** (using "query wizard"): http://stats.oecd.org/qwids/#?x=5,1,2,3&y=6&f=4:1,7:1,9:85,8:85&q=4:1+7:1+9:85+8:85+5:3,4+1:3,4,5,6,58,7,8,9,10,11,59,60,12,13,14,61,15,16,17,18,62,19,63,75,20,21,22,23,24,36,209,195,197,169,190,70,204,176,170,171,172,173,174,175,191,69,67,205,64,76,211,47,212,213,30,31,214,32,33,215,43,44,34,202,35,179,216,203,72,48,206,68,49,73,194,50,51,52,181,53,55,74,217,218,41,42,45,219,199,196,177,200,71,37,38,198,39,40,178,193,77,78+2:2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,189,25,27,28,31,29,30,32,33,34,35,36,37,38,39,41,42,43,44,45,46,47,89,40,49,50,51,53,54,55,56,57,59,273,63,62,64,65,66,67,68,69,70,71,72,73,74,75,76,78,79,81,82,83,84,85,86,87,88,90,274,91,92,93,95,96,97,98,100,101,102,103,104,105,106,107,108,109,110,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,135,136,137,138,139,141,144,159,160,161,162,145,146,147,148,149,150,151,152,154,155,156,157,275,158,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,190,134,191,192,193+3:21,22,23,24,26,27,28,29,30,31,32,33,137+6:2010,2011,2012,2013,2014,2015&lock=CRS1
**Data Obtained Date:** 8/8/2017

```{r crs_data, eval = FALSE}
## note that filepaths have to be relative to .Rmd file in order to work
## ignore the first four rows (headers appear on multiple rows) and specify colnames in R
## ignore the 5th column, as well as 12th and 13th column (they're empty)
## WARNING: if you change the data, or the order of the fields, UPDATE THIS PIECE OF CODE
crs <- read.csv("../data/crs/results.csv", 
                stringsAsFactors = FALSE)[-c(1:4),-c(5, 12:13)]

names(crs) <- c("flow_type", "donor", "recipient", "sector",
                "year2010", "year2011", "year2012", "year2013", "year2014", "year2015")

```

## G-Finder

**Source:** Policy Cures G-Finder
**Dataset:** Neglected Disease Funding for all diseases - all products for FYI 2015
**Brief description:** The G-Finder database provides information on funding for 35 neglected diseases across 142 product areas including drugs, vaccines, diagnostics, microbicides, and vector control products. Data are collected by survey and manually collated and reviewed by the Policy Cures team.
**Level of aggregation:** Disease, Secondary-level Disease, Product, Funder, Funding Type, Recipeint, Year
**Location:** https://gfinder.policycuresresearch.org/PublicSearchTool/
**Data Obtained Date:** 8/8/2017
**Note:** It's possible to export data for long periods than just one year, but selecting especially long time periods caused the data exporter tool to return an error and no data.

```{r gfinder_data}
## note that filepaths have to be relative to .Rmd file in order to work
gfinder <- read.csv("../data/gfinder/raw/Public Search Tool 2017-08-09.csv", 
                 stringsAsFactors = FALSE)
```

### Data Processing 

Format dollars to appear as numers (exclude commas) and remove FY from the beginning of printed years. Add G-Finder as data source.

```{r}
## remove commas from dollar amounts
gfinder$Amount..US.. <- gsub(",", "", gfinder$Amount..US..)

## remove "FY" from the beginning of printed years
gfinder$Year.description <- as.numeric(as.character(gsub("FY ", "", gfinder$Year.description)))

gfinder$data_source <- "G-Finder"

## save processed data (that was easy!)
## save data if csv_flag is true
## don't print rownames in csv
if(csv_flag == TRUE){
  write.csv(gfinder,
            file = "../data/gfinder/processed/gfinder_processed.csv", 
            row.names = FALSE)
}
```


## IHME

**Source:** IHME (Institute for Health Metrics and Evaluation, University of Washington)  
**Dataset:** Development Assistance for Health Database 1990-2016  
**Brief description:** Information on global health assistance during the timeframe specified, based on data obtained from project databases, financial statements, annual reports, IRS 990s, and correspondence with agencies.  
**Level of aggregation:** Funder, country, geographic region, health focus area  
**Location:** http://ghdx.healthdata.org/record/development-assistance-health-database-1990-2016  
**Data Obtained Date:** 8/7/2017

```{r ihme_data}
## note that filepaths have to be relative to .Rmd file in order to work
ihme <- read.csv("../data/ihme/raw/IHME_DAH_DATABASE_1990_2016_Y2017M04D19.CSV", 
                 stringsAsFactors = FALSE)
```

### Data Processing 

Exclude preliominary estimates and duplicated entries that could cause double-counting.

```{r}
ihme_selected <- ihme[which(## exclude to avoid double counting
                            ihme$elim_ch >= 0 & 
                            ## exclude preliminary estimates
                            ihme$prelim_est == 0) 
                      ,]
```

Restructure dataset from wide to long, so that we have one row per year-funder-recipient-purpose, as opposed to the original structure of one row per year-funder-recipient with individual columns corresponding to purpose. Only restructure specific fields of interest:  
**ch_cnv_dah_15:** funds for health dispursed from source to channel to recipient country for newborn and child health, disaggregated by vaccines;  
**oid_hhs_dah_15:** funds for health dispursed from source to channel to recipient country for infectious diseases, disaggregated by health system support;  
**oid_other_dah_15:** funds for health dispursed from source to channel to recipient country for infectious diseases, disaggregated by everything other than health system support;  
**mal_con_nets_dah_15:** funds for health dispursed from source to channel to recipient country for malaria, disaggregated by bednets;  
**mal_con_diag_dah_15:** funds for health dispursed from source to channel to recipient country for malaria, disaggregated by diagnosis;  
**mal_con_irs_dah_15:** funds for health dispursed from source to channel to recipient country for malaria, disaggregated by indoor spraying;  
**mal_treat_dah_15:** funds for health dispursed from source to channel to recipient country for malaria, disaggregated by treatment;  
**mal_hhs_dah_15:** funds for health dispursed from source to channel to recipient country for malaria, disaggregated by health system support;  
**mal_unid_dah_15:** funds for health dispursed from source to channel to recipient country for malaria, disaggregated by unspecified function;  
**tb_hhs_dah_15:** funds for health dispursed from source to channel to recipient country for Tuberculosis, disaggregated by health system support;  
**tb_other_dah_15:** funds for health dispursed from source to channel to recipient country for Tuberculosis, disaggregated by everything other than health system support

These fields, and associated descriptive information, are specified in the file relevant_fields in the data/ihme subdirectory.

```{r}
## read in file specifying fields of interest
selected_ihme_fieldnames <- read.csv("../data/ihme/relevant_fields.csv", stringsAsFactors = FALSE)

## vector of indices corresponding to the fieldnames we care about
selected_ihme_fieldnum <- which(names(ihme_selected) %in% selected_ihme_fieldnames$fieldname)

## use the fields that we specified above,
## plus other selected fields including year (1), source (2), and channel (3),
## recipient_country (5)
## then melt the data from wide to long, such that there is one row per
## year-funder-recipient-purpose
ihme_restructured <- melt(ihme_selected[,c(1,2,3,5, selected_ihme_fieldnum)],
     id.vars = c("year", "source", "channel", "recipient_country"),
     value.name = "amount",
     variable.name = "intial_variable_name_ihme")

## exclude rows corresponding to no funding (amount = 0)
## do this only if at least one row has amount = 0
if(any(ihme_restructured$amount == 0)){
  ihme_restructured <- ihme_restructured[-which(ihme_restructured$amount == 0),]
}

## merge this restructured data with data mapping "purpose" field (initial colnames of the dataset)
## to relevant descriptive data based on information provided in the IHME codebook
ihme_restructured_full <- merge(ihme_restructured, selected_ihme_fieldnames,
                                by.x = "intial_variable_name_ihme", by.y = "fieldname",
                                all.x = TRUE)

## add field indicating that these data came from IHME
ihme_restructured_full <- cbind.data.frame(ihme_restructured_full, 
                                           data_source = "IHME")

## reorder fields so that dataframe is shown in a logical order from "left" to "right"
ihme_restructured_full <- ihme_restructured_full[,c(2,3,5,4,6,7,8,9,1)]
```

```{r}
## save data if csv_flag is true
## don't print rownames in csv
if(csv_flag == TRUE){
  write.csv(ihme_restructured_full,
            file = "../data/ihme/processed/ihme_processed.csv", 
            row.names = FALSE)
}
```

## OIE

**Source:** OIE (World Organization for Animal Health)  
**Dataset:** OIE Procurement Contracts, Grants and Sub-Grants awarded by the OIE with funding by the European Union (EU)  
**Brief description:** All active contribution agreements signed between the OIE and the EU in support of OIE programs, project, and activities. EU Only.  
**Level of aggregation:** Funder (always EU), Recipient, Program, Year  
**Location:** http://www.oie.int/fileadmin/Home/eng/Support_to_OIE_Members/pdf/EU_Procurement-contracts-and-Grants-published_SEP-2016_01.pdf  
**Data Obtained Date:** 8/8/2017  
**Note:** Data manually extracted from pdf 

```{r oie_data}
## note that filepaths have to be relative to .Rmd file in order to work
oie <- read.table("../data/oie/raw/eu_contracts.csv", 
                 stringsAsFactors = FALSE, sep = "\t", header = TRUE)
```

### Data Processing

Extract year from field Date.of.Signature.of.Contract, add OIE as funder.

```{r}
## format field date of signature as a date
oie$Date.of.Signature.of.Contract <- as.Date(oie$Date.of.Signature.of.Contract, format = "%d/%m/%Y")

## extract year of date of contract signature
oie$Year.of.Signature.of.Contract <- as.numeric(as.character(format(oie$Date.of.Signature.of.Contract, format = "%Y")))

oie$Funder <- "OIE"
oie$data_source = "OIE"
```

```{r}
## save data if csv_flag is true
## don't print rownames in csv
if(csv_flag == TRUE){
  write.csv(oie,
            file = "../data/oie/processed/oie_processed.csv", 
            row.names = FALSE)
}
```


